
# Replicated Log (Python + Flask + Docker)

[![Test with 2 Nodes](https://github.com/elgrassa/replicated-log-python/actions/workflows/test.yml/badge.svg)](https://github.com/elgrassa/replicated-log-python/actions/workflows/test.yml)

This repo contains two iterations:

## Iteration 0 — Echo (TCP) client/server
A minimal TCP echo pair to prove the environment.

Run locally (no Docker required):
```bash
python echo/echo_server.py 9009
# in another shell
python echo/echo_client.py 127.0.0.1 9009 "hello world"
```

## Iteration 1 — Blocking Replicated Log

**Architecture**
- 1 Master (HTTP)
- N Secondaries (HTTP)
- After a client `POST /messages`, the Master replicates the message to *all* Secondaries and waits for ACKs **before** returning to the client (blocking replication).
- Secondaries can simulate slow replication via an optional delay.

### API
**Master**
- `POST /messages` with JSON: `{ "msg": "text" }` → `201` after all ACKs received, returns current log: `{ "messages": [...] }`
- `GET /messages` → `{ "messages": [...] }`

**Secondary**
- `GET /messages` → `{ "messages": [...] }`
- (internal) `POST /replicate` with JSON `{ "msg": "text" }` → `{ "status": "ok" }`

### Build and Run

#### Quick Start (Default: 2 Secondaries)

```bash
# From repo root - build and start all services
docker compose up --build -d

# Verify containers are running
docker compose ps
```

This will start:
- Master on **http://localhost:8000**
- Secondary 1 on **http://localhost:8001**
- Secondary 2 on **http://localhost:8002** (with 1.5s artificial delay to show blocking)

#### Configure N Number of Nodes

To use more than 2 secondaries:

```bash
# Set number of secondaries
export NUM_SECONDARIES=5

# Set delays for each secondary (comma-separated)
export SECONDARY_DELAYS="0,100,500,1000,2000"

# Generate docker-compose.yml with N nodes
python3 generate_compose.py

# Build and start
docker compose up --build -d
```

Configuration options:
- `NUM_SECONDARIES` - number of secondary nodes (default: 2)
- `SECONDARY_DELAYS` - comma-separated delays in ms (default: "0,1500")
- `MASTER_PORT` - master port (default: 8000)

Ports are assigned sequentially: master on 8000, secondaries starting at 8001.

**Example: 3 secondaries with different delays**
```bash
export NUM_SECONDARIES=3
export SECONDARY_DELAYS="0,500,2000"
python3 generate_compose.py
docker compose up --build -d
```

### Testing

Quick health check:
```bash
curl -s http://localhost:8000/health | jq
curl -s http://localhost:8001/health | jq
curl -s http://localhost:8002/health | jq
```

Get all messages (empty at first):
```bash
curl -s http://localhost:8000/messages | jq
```

Post a message:
```bash
curl -s -X POST http://localhost:8000/messages \
  -H 'Content-Type: application/json' \
  -d '{"msg":"test"}' | jq
```

Check replication on secondaries:
```bash
curl -s http://localhost:8001/messages | jq
curl -s http://localhost:8002/messages | jq
```

Test blocking behavior (should take ~1.5s due to secondary2 delay):
```bash
time curl -s -X POST http://localhost:8000/messages \
  -H 'Content-Type: application/json' \
  -d '{"msg":"blocking test"}'
```

Verify consistency across all nodes:
```bash
curl -s http://localhost:8000/messages | jq '.messages'
curl -s http://localhost:8001/messages | jq '.messages'
curl -s http://localhost:8002/messages | jq '.messages'
```

Error handling test:
```bash
curl -i -X POST http://localhost:8000/messages \
  -H 'Content-Type: application/json' \
  -d '{"nope":123}'
```

View logs:
```bash
docker compose logs master
docker compose logs secondary1
docker compose logs secondary2
```

Run automated tests:
```bash
./scripts/verify.sh
# or
pytest -q tests/smoke_test.py
```

### Configuration

Use `generate_compose.py` to configure N secondary nodes. The script generates `docker-compose.yml` automatically.

Master reads secondary URLs from `SECONDARIES` env var (generated by the script). Example: `SECONDARIES=http://secondary1:8001,http://secondary2:8001`

Secondaries support:
- `PORT` (default `8001`)
- `DELAY_MS` (default `0`) — artificial delay to demonstrate blocking replication

### Logs
All services log to stdout. View with `docker compose logs`.

### Cleanup

```bash
# Stop containers
docker compose down

# Stop and remove volumes
docker compose down -v
```

### Notes / Assumptions
- No failures/packet loss (as per task). If a Secondary is unreachable, Master returns 502 with details.
- In-memory lists only; restart loses data.
- Simple one-phase replication for clarity (no WAL/2PC/etc).

