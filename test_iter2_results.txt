Running in CI environment
==========================================
Iteration 2 Test Suite
Testing with 2 secondary node(s)
==========================================

==========================================
A. Write Concern Semantics
==========================================

A1. WC-01: Default write concern (all replicas)
----------------------------------------
✅ All services healthy

Clearing previous messages...
POST /messages with default w (no w parameter)...
Response: w=3, ACKs=2, duration_ms=1510ms
Real elapsed time: 1.538s
✅ w matches expected: 3
✅ ACK count matches: 2
Checking consistency...
❌ Mismatch on port 8001
❌ Mismatch on port 8002
❌ Inconsistency detected

A2. WC-02: w=1 (master-only, fast)
----------------------------------------
Testing: w=1 should be fast (<100ms) and still replicate asynchronously
POST /messages with w=1...
Response: w=1, ACKs=0, duration_ms=2ms
Real elapsed time: 0.016s
✅ w=1 confirmed
✅ No ACKs from secondaries (as expected for w=1)
✅ Fast response (<100ms)
Checking logs for async replication...
rl-master  | 2025-12-07 21:28:56,127 | INFO | Appended locally seq=158 msg=w1_test
rl-master  | 2025-12-07 21:28:56,128 | INFO | w=1: Replicating to all secondaries asynchronously (not waiting for ACKs)
rl-master  | 2025-12-07 21:28:56,130 | INFO | POST /messages completed w=1, acks=0 in 2 ms
Checking immediate inconsistency...
⚠️  Inconsistency check: master=true, missing=0
Waiting 3 seconds for eventual consistency...
✅ Eventual consistency: all nodes now have the message

A3. WC-03: w=2 (master + one secondary)
----------------------------------------
POST /messages with w=2...
Testing: w=2 should respond after 1st ACK (fast, ~0-10ms if fast secondary responds first)
Response: w=2, ACKs=1, duration_ms=5ms
Real elapsed time: 0.020s
✅ w=2 confirmed
✅ At least 1 ACK received (got 1)
✅ Response time reasonable: 5ms
Checking logs for timing details...
rl-master  | 2025-12-07 21:28:56,052 | INFO | Write concern w=3 satisfied with 2 ACKs, responding (remaining replications continue)
rl-master  | 2025-12-07 21:28:59,310 | INFO | Appended locally seq=159 msg=w2_test
rl-master  | 2025-12-07 21:28:59,316 | INFO | Write concern w=2 satisfied with 1 ACKs, responding (remaining replications continue)

==========================================
B. Eventual Consistency & Async Replication
==========================================

B1. EV-01: Controlled inconsistency window
----------------------------------------
Sending 3 messages with w=1 quickly...
Immediately checking messages...
Master: ["smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","test message 1","blocking test","message 2","message 3","message 4","delay test","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765140835121","w1_fast_1765140837664","w2_1765140837672","w3_1765140837679","w_max_1765140839191","w1_no_acks_1765140842729","w2_one_ack_1765140842740","ev1_1765140842748_0","ev1_1765140842748_1","ev1_1765140842748_2","mix_1765140847625_1","mix_1765140847625_2","mix_1765140847625_3","temp_diff_1765140853794","delayed_1765140857832_0","delayed_1765140857832_1","delayed_1765140857832_2","dedup_test_1765140862195","ord_1765140864753_1","ord_1765140864753_2","ord_1765140864753_3","ord_1765140864753_4","ord_1765140864753_5","delay_ord_1765140873858_1","delay_ord_1765140873858_2","delay_ord_1765140873858_3","mixed_1765140878229_1","mixed_1765140878229_2","mixed_1765140878229_3","mixed_1765140878229_4","ooo_1765140884614_1","ooo_1765140884614_2","ooo_1765140884614_3","need_two_1765140892266","available_1765140897741","timing_w1_1765140899941","timing_w2_1765140899955","concurrent_1765140899966_1","concurrent_1765140899966_2","concurrent_1765140899966_0","concurrent_1765140899966_3","concurrent_1765140899966_4","concurrent_1765140899966_5","concurrent_1765140899966_8","concurrent_1765140899966_6","concurrent_1765140899966_7","concurrent_1765140899966_9","w1_test","w2_test","eventual_test_1765140925791","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765142452041","w1_fast_1765142454578","w2_1765142454589","w3_1765142454597","w_max_1765142456112","w1_no_acks_1765142459655","w2_one_ack_1765142459666","ev1_1765142459673_0","ev1_1765142459673_1","ev1_1765142459673_2","mix_1765142464574_1","mix_1765142464574_2","mix_1765142464574_3","temp_diff_1765142470760","delayed_1765142474796_0","delayed_1765142474796_1","delayed_1765142474796_2","dedup_test_1765142479167","ord_1765142481759_1","ord_1765142481759_2","ord_1765142481759_3","ord_1765142481759_4","ord_1765142481759_5","delay_ord_1765142490878_1","delay_ord_1765142490878_2","delay_ord_1765142490878_3","mixed_1765142495256_1","mixed_1765142495256_2","mixed_1765142495256_3","mixed_1765142495256_4","ooo_1765142501648_1","ooo_1765142501648_2","ooo_1765142501648_3","need_two_1765142509301","available_1765142514751","timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3"]
Secondary (port 8001): ["smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","test message 1","blocking test","message 2","message 3","message 4","delay test","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765140835121","w1_fast_1765140837664","w2_1765140837672","w3_1765140837679","w_max_1765140839191","w1_no_acks_1765140842729","w2_one_ack_1765140842740","ev1_1765140842748_0","ev1_1765140842748_1","ev1_1765140842748_2","mix_1765140847625_1","mix_1765140847625_2","mix_1765140847625_3","temp_diff_1765140853794","delayed_1765140857832_0","delayed_1765140857832_1","delayed_1765140857832_2","dedup_test_1765140862195","ord_1765140864753_1","ord_1765140864753_2","ord_1765140864753_3","ord_1765140864753_4","ord_1765140864753_5","delay_ord_1765140873858_1","delay_ord_1765140873858_2","delay_ord_1765140873858_3","mixed_1765140878229_1","mixed_1765140878229_2","mixed_1765140878229_3","mixed_1765140878229_4","ooo_1765140884614_1","ooo_1765140884614_2","ooo_1765140884614_3","need_two_1765140892266","available_1765140897741","timing_w1_1765140899941","timing_w2_1765140899955","concurrent_1765140899966_1","concurrent_1765140899966_2","concurrent_1765140899966_0","concurrent_1765140899966_3","concurrent_1765140899966_4","concurrent_1765140899966_5","concurrent_1765140899966_8","concurrent_1765140899966_6","concurrent_1765140899966_7","concurrent_1765140899966_9","w1_test","w2_test","eventual_test_1765140925791","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765142452041","w1_fast_1765142454578","w2_1765142454589","w3_1765142454597","w_max_1765142456112","w1_no_acks_1765142459655","w2_one_ack_1765142459666","ev1_1765142459673_0","ev1_1765142459673_1","ev1_1765142459673_2","mix_1765142464574_1","mix_1765142464574_2","mix_1765142464574_3","temp_diff_1765142470760","delayed_1765142474796_0","delayed_1765142474796_1","delayed_1765142474796_2","dedup_test_1765142479167","ord_1765142481759_1","ord_1765142481759_2","ord_1765142481759_3","ord_1765142481759_4","ord_1765142481759_5","delay_ord_1765142490878_1","delay_ord_1765142490878_2","delay_ord_1765142490878_3","mixed_1765142495256_1","mixed_1765142495256_2","mixed_1765142495256_3","mixed_1765142495256_4","ooo_1765142501648_1","ooo_1765142501648_2","ooo_1765142501648_3","need_two_1765142509301","available_1765142514751","timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3","order_764744_0","order_764744_1","order_764744_2","order_781739_0","order_781739_1","order_781739_2","dedup_multi_864734","dedup_multi_881717","test_dedup_964725","test_dedup_981698"]
Secondary (port 8002): ["timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test"]
Waiting 3 seconds for eventual consistency...
After wait:
Master: ["smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","test message 1","blocking test","message 2","message 3","message 4","delay test","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765140835121","w1_fast_1765140837664","w2_1765140837672","w3_1765140837679","w_max_1765140839191","w1_no_acks_1765140842729","w2_one_ack_1765140842740","ev1_1765140842748_0","ev1_1765140842748_1","ev1_1765140842748_2","mix_1765140847625_1","mix_1765140847625_2","mix_1765140847625_3","temp_diff_1765140853794","delayed_1765140857832_0","delayed_1765140857832_1","delayed_1765140857832_2","dedup_test_1765140862195","ord_1765140864753_1","ord_1765140864753_2","ord_1765140864753_3","ord_1765140864753_4","ord_1765140864753_5","delay_ord_1765140873858_1","delay_ord_1765140873858_2","delay_ord_1765140873858_3","mixed_1765140878229_1","mixed_1765140878229_2","mixed_1765140878229_3","mixed_1765140878229_4","ooo_1765140884614_1","ooo_1765140884614_2","ooo_1765140884614_3","need_two_1765140892266","available_1765140897741","timing_w1_1765140899941","timing_w2_1765140899955","concurrent_1765140899966_1","concurrent_1765140899966_2","concurrent_1765140899966_0","concurrent_1765140899966_3","concurrent_1765140899966_4","concurrent_1765140899966_5","concurrent_1765140899966_8","concurrent_1765140899966_6","concurrent_1765140899966_7","concurrent_1765140899966_9","w1_test","w2_test","eventual_test_1765140925791","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765142452041","w1_fast_1765142454578","w2_1765142454589","w3_1765142454597","w_max_1765142456112","w1_no_acks_1765142459655","w2_one_ack_1765142459666","ev1_1765142459673_0","ev1_1765142459673_1","ev1_1765142459673_2","mix_1765142464574_1","mix_1765142464574_2","mix_1765142464574_3","temp_diff_1765142470760","delayed_1765142474796_0","delayed_1765142474796_1","delayed_1765142474796_2","dedup_test_1765142479167","ord_1765142481759_1","ord_1765142481759_2","ord_1765142481759_3","ord_1765142481759_4","ord_1765142481759_5","delay_ord_1765142490878_1","delay_ord_1765142490878_2","delay_ord_1765142490878_3","mixed_1765142495256_1","mixed_1765142495256_2","mixed_1765142495256_3","mixed_1765142495256_4","ooo_1765142501648_1","ooo_1765142501648_2","ooo_1765142501648_3","need_two_1765142509301","available_1765142514751","timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3"]
Secondary (port 8001): ["smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","test message 1","blocking test","message 2","message 3","message 4","delay test","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765140835121","w1_fast_1765140837664","w2_1765140837672","w3_1765140837679","w_max_1765140839191","w1_no_acks_1765140842729","w2_one_ack_1765140842740","ev1_1765140842748_0","ev1_1765140842748_1","ev1_1765140842748_2","mix_1765140847625_1","mix_1765140847625_2","mix_1765140847625_3","temp_diff_1765140853794","delayed_1765140857832_0","delayed_1765140857832_1","delayed_1765140857832_2","dedup_test_1765140862195","ord_1765140864753_1","ord_1765140864753_2","ord_1765140864753_3","ord_1765140864753_4","ord_1765140864753_5","delay_ord_1765140873858_1","delay_ord_1765140873858_2","delay_ord_1765140873858_3","mixed_1765140878229_1","mixed_1765140878229_2","mixed_1765140878229_3","mixed_1765140878229_4","ooo_1765140884614_1","ooo_1765140884614_2","ooo_1765140884614_3","need_two_1765140892266","available_1765140897741","timing_w1_1765140899941","timing_w2_1765140899955","concurrent_1765140899966_1","concurrent_1765140899966_2","concurrent_1765140899966_0","concurrent_1765140899966_3","concurrent_1765140899966_4","concurrent_1765140899966_5","concurrent_1765140899966_8","concurrent_1765140899966_6","concurrent_1765140899966_7","concurrent_1765140899966_9","w1_test","w2_test","eventual_test_1765140925791","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765142452041","w1_fast_1765142454578","w2_1765142454589","w3_1765142454597","w_max_1765142456112","w1_no_acks_1765142459655","w2_one_ack_1765142459666","ev1_1765142459673_0","ev1_1765142459673_1","ev1_1765142459673_2","mix_1765142464574_1","mix_1765142464574_2","mix_1765142464574_3","temp_diff_1765142470760","delayed_1765142474796_0","delayed_1765142474796_1","delayed_1765142474796_2","dedup_test_1765142479167","ord_1765142481759_1","ord_1765142481759_2","ord_1765142481759_3","ord_1765142481759_4","ord_1765142481759_5","delay_ord_1765142490878_1","delay_ord_1765142490878_2","delay_ord_1765142490878_3","mixed_1765142495256_1","mixed_1765142495256_2","mixed_1765142495256_3","mixed_1765142495256_4","ooo_1765142501648_1","ooo_1765142501648_2","ooo_1765142501648_3","need_two_1765142509301","available_1765142514751","timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3","order_764744_0","order_764744_1","order_764744_2","order_781739_0","order_781739_1","order_781739_2","dedup_multi_864734","dedup_multi_881717","test_dedup_964725","test_dedup_981698"]
Secondary (port 8002): ["timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3"]
⚠️  Some nodes still inconsistent

B2. EV-02: Mixed write concerns eventually align
----------------------------------------
Sending mixed w values...
Waiting for all replication...
Checking final state...
Master: ["smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","test message 1","blocking test","message 2","message 3","message 4","delay test","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765140835121","w1_fast_1765140837664","w2_1765140837672","w3_1765140837679","w_max_1765140839191","w1_no_acks_1765140842729","w2_one_ack_1765140842740","ev1_1765140842748_0","ev1_1765140842748_1","ev1_1765140842748_2","mix_1765140847625_1","mix_1765140847625_2","mix_1765140847625_3","temp_diff_1765140853794","delayed_1765140857832_0","delayed_1765140857832_1","delayed_1765140857832_2","dedup_test_1765140862195","ord_1765140864753_1","ord_1765140864753_2","ord_1765140864753_3","ord_1765140864753_4","ord_1765140864753_5","delay_ord_1765140873858_1","delay_ord_1765140873858_2","delay_ord_1765140873858_3","mixed_1765140878229_1","mixed_1765140878229_2","mixed_1765140878229_3","mixed_1765140878229_4","ooo_1765140884614_1","ooo_1765140884614_2","ooo_1765140884614_3","need_two_1765140892266","available_1765140897741","timing_w1_1765140899941","timing_w2_1765140899955","concurrent_1765140899966_1","concurrent_1765140899966_2","concurrent_1765140899966_0","concurrent_1765140899966_3","concurrent_1765140899966_4","concurrent_1765140899966_5","concurrent_1765140899966_8","concurrent_1765140899966_6","concurrent_1765140899966_7","concurrent_1765140899966_9","w1_test","w2_test","eventual_test_1765140925791","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765142452041","w1_fast_1765142454578","w2_1765142454589","w3_1765142454597","w_max_1765142456112","w1_no_acks_1765142459655","w2_one_ack_1765142459666","ev1_1765142459673_0","ev1_1765142459673_1","ev1_1765142459673_2","mix_1765142464574_1","mix_1765142464574_2","mix_1765142464574_3","temp_diff_1765142470760","delayed_1765142474796_0","delayed_1765142474796_1","delayed_1765142474796_2","dedup_test_1765142479167","ord_1765142481759_1","ord_1765142481759_2","ord_1765142481759_3","ord_1765142481759_4","ord_1765142481759_5","delay_ord_1765142490878_1","delay_ord_1765142490878_2","delay_ord_1765142490878_3","mixed_1765142495256_1","mixed_1765142495256_2","mixed_1765142495256_3","mixed_1765142495256_4","ooo_1765142501648_1","ooo_1765142501648_2","ooo_1765142501648_3","need_two_1765142509301","available_1765142514751","timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3"]
Secondary (port 8001): ["smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","smoke","pytest","test message 1","blocking test","message 2","message 3","message 4","delay test","test message 1","blocking test","message 2","message 3","message 4","delay test","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765140835121","w1_fast_1765140837664","w2_1765140837672","w3_1765140837679","w_max_1765140839191","w1_no_acks_1765140842729","w2_one_ack_1765140842740","ev1_1765140842748_0","ev1_1765140842748_1","ev1_1765140842748_2","mix_1765140847625_1","mix_1765140847625_2","mix_1765140847625_3","temp_diff_1765140853794","delayed_1765140857832_0","delayed_1765140857832_1","delayed_1765140857832_2","dedup_test_1765140862195","ord_1765140864753_1","ord_1765140864753_2","ord_1765140864753_3","ord_1765140864753_4","ord_1765140864753_5","delay_ord_1765140873858_1","delay_ord_1765140873858_2","delay_ord_1765140873858_3","mixed_1765140878229_1","mixed_1765140878229_2","mixed_1765140878229_3","mixed_1765140878229_4","ooo_1765140884614_1","ooo_1765140884614_2","ooo_1765140884614_3","need_two_1765140892266","available_1765140897741","timing_w1_1765140899941","timing_w2_1765140899955","concurrent_1765140899966_1","concurrent_1765140899966_2","concurrent_1765140899966_0","concurrent_1765140899966_3","concurrent_1765140899966_4","concurrent_1765140899966_5","concurrent_1765140899966_8","concurrent_1765140899966_6","concurrent_1765140899966_7","concurrent_1765140899966_9","w1_test","w2_test","eventual_test_1765140925791","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","dup_test","ord1","ord2","ord3","ord4","ord5","w1_timing_verify","w2_timing_verify","default_w_1765142452041","w1_fast_1765142454578","w2_1765142454589","w3_1765142454597","w_max_1765142456112","w1_no_acks_1765142459655","w2_one_ack_1765142459666","ev1_1765142459673_0","ev1_1765142459673_1","ev1_1765142459673_2","mix_1765142464574_1","mix_1765142464574_2","mix_1765142464574_3","temp_diff_1765142470760","delayed_1765142474796_0","delayed_1765142474796_1","delayed_1765142474796_2","dedup_test_1765142479167","ord_1765142481759_1","ord_1765142481759_2","ord_1765142481759_3","ord_1765142481759_4","ord_1765142481759_5","delay_ord_1765142490878_1","delay_ord_1765142490878_2","delay_ord_1765142490878_3","mixed_1765142495256_1","mixed_1765142495256_2","mixed_1765142495256_3","mixed_1765142495256_4","ooo_1765142501648_1","ooo_1765142501648_2","ooo_1765142501648_3","need_two_1765142509301","available_1765142514751","timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3","order_764744_0","order_764744_1","order_764744_2","order_781739_0","order_781739_1","order_781739_2","dedup_multi_864734","dedup_multi_881717","test_dedup_964725","test_dedup_981698"]
Secondary (port 8002): ["timing_w1_1765142516943","timing_w2_1765142516953","concurrent_1765142516960_4","concurrent_1765142516960_0","concurrent_1765142516960_3","concurrent_1765142516960_1","concurrent_1765142516960_6","concurrent_1765142516960_2","concurrent_1765142516960_5","concurrent_1765142516960_7","concurrent_1765142516960_8","concurrent_1765142516960_9","w1_test","w2_test","eventual_test_1765142521458","default_w","w1_test","w2_test","e1","e2","e3","mix1","mix2","mix3"]
⚠️  Some nodes still inconsistent

==========================================
C. Deduplication & Total Ordering
==========================================

C1. DED-01: Secondary deduplicates same seq
----------------------------------------
Testing deduplication on secondary (port 8001)...
Sending same message twice via master (simulating retry)...
Occurrences of 'dup_test' on secondary: 3
⚠️  Expected 1 occurrence, got 3

C2. ORD-01: Global total ordering
----------------------------------------
Sending 5 messages with mixed w values...
Waiting for all replication...
Checking ordering across all nodes...
Master order: smoke,pytest,test message 1,blocking test,message 2,message 3,message 4,delay test,smoke,pytest,test message 1,blocking test,message 2,message 3,message 4,delay test,test message 1,blocking test,message 2,message 3,message 4,delay test,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5,w1_timing_verify,w2_timing_verify,default_w_1765140835121,w1_fast_1765140837664,w2_1765140837672,w3_1765140837679,w_max_1765140839191,w1_no_acks_1765140842729,w2_one_ack_1765140842740,ev1_1765140842748_0,ev1_1765140842748_1,ev1_1765140842748_2,mix_1765140847625_1,mix_1765140847625_2,mix_1765140847625_3,temp_diff_1765140853794,delayed_1765140857832_0,delayed_1765140857832_1,delayed_1765140857832_2,dedup_test_1765140862195,ord_1765140864753_1,ord_1765140864753_2,ord_1765140864753_3,ord_1765140864753_4,ord_1765140864753_5,delay_ord_1765140873858_1,delay_ord_1765140873858_2,delay_ord_1765140873858_3,mixed_1765140878229_1,mixed_1765140878229_2,mixed_1765140878229_3,mixed_1765140878229_4,ooo_1765140884614_1,ooo_1765140884614_2,ooo_1765140884614_3,need_two_1765140892266,available_1765140897741,timing_w1_1765140899941,timing_w2_1765140899955,concurrent_1765140899966_1,concurrent_1765140899966_2,concurrent_1765140899966_0,concurrent_1765140899966_3,concurrent_1765140899966_4,concurrent_1765140899966_5,concurrent_1765140899966_8,concurrent_1765140899966_6,concurrent_1765140899966_7,concurrent_1765140899966_9,w1_test,w2_test,eventual_test_1765140925791,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5,w1_timing_verify,w2_timing_verify,default_w_1765142452041,w1_fast_1765142454578,w2_1765142454589,w3_1765142454597,w_max_1765142456112,w1_no_acks_1765142459655,w2_one_ack_1765142459666,ev1_1765142459673_0,ev1_1765142459673_1,ev1_1765142459673_2,mix_1765142464574_1,mix_1765142464574_2,mix_1765142464574_3,temp_diff_1765142470760,delayed_1765142474796_0,delayed_1765142474796_1,delayed_1765142474796_2,dedup_test_1765142479167,ord_1765142481759_1,ord_1765142481759_2,ord_1765142481759_3,ord_1765142481759_4,ord_1765142481759_5,delay_ord_1765142490878_1,delay_ord_1765142490878_2,delay_ord_1765142490878_3,mixed_1765142495256_1,mixed_1765142495256_2,mixed_1765142495256_3,mixed_1765142495256_4,ooo_1765142501648_1,ooo_1765142501648_2,ooo_1765142501648_3,need_two_1765142509301,available_1765142514751,timing_w1_1765142516943,timing_w2_1765142516953,concurrent_1765142516960_4,concurrent_1765142516960_0,concurrent_1765142516960_3,concurrent_1765142516960_1,concurrent_1765142516960_6,concurrent_1765142516960_2,concurrent_1765142516960_5,concurrent_1765142516960_7,concurrent_1765142516960_8,concurrent_1765142516960_9,w1_test,w2_test,eventual_test_1765142521458,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5
Secondary (port 8001) order: smoke,pytest,test message 1,blocking test,message 2,message 3,message 4,delay test,smoke,pytest,test message 1,blocking test,message 2,message 3,message 4,delay test,test message 1,blocking test,message 2,message 3,message 4,delay test,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5,w1_timing_verify,w2_timing_verify,default_w_1765140835121,w1_fast_1765140837664,w2_1765140837672,w3_1765140837679,w_max_1765140839191,w1_no_acks_1765140842729,w2_one_ack_1765140842740,ev1_1765140842748_0,ev1_1765140842748_1,ev1_1765140842748_2,mix_1765140847625_1,mix_1765140847625_2,mix_1765140847625_3,temp_diff_1765140853794,delayed_1765140857832_0,delayed_1765140857832_1,delayed_1765140857832_2,dedup_test_1765140862195,ord_1765140864753_1,ord_1765140864753_2,ord_1765140864753_3,ord_1765140864753_4,ord_1765140864753_5,delay_ord_1765140873858_1,delay_ord_1765140873858_2,delay_ord_1765140873858_3,mixed_1765140878229_1,mixed_1765140878229_2,mixed_1765140878229_3,mixed_1765140878229_4,ooo_1765140884614_1,ooo_1765140884614_2,ooo_1765140884614_3,need_two_1765140892266,available_1765140897741,timing_w1_1765140899941,timing_w2_1765140899955,concurrent_1765140899966_1,concurrent_1765140899966_2,concurrent_1765140899966_0,concurrent_1765140899966_3,concurrent_1765140899966_4,concurrent_1765140899966_5,concurrent_1765140899966_8,concurrent_1765140899966_6,concurrent_1765140899966_7,concurrent_1765140899966_9,w1_test,w2_test,eventual_test_1765140925791,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5,w1_timing_verify,w2_timing_verify,default_w_1765142452041,w1_fast_1765142454578,w2_1765142454589,w3_1765142454597,w_max_1765142456112,w1_no_acks_1765142459655,w2_one_ack_1765142459666,ev1_1765142459673_0,ev1_1765142459673_1,ev1_1765142459673_2,mix_1765142464574_1,mix_1765142464574_2,mix_1765142464574_3,temp_diff_1765142470760,delayed_1765142474796_0,delayed_1765142474796_1,delayed_1765142474796_2,dedup_test_1765142479167,ord_1765142481759_1,ord_1765142481759_2,ord_1765142481759_3,ord_1765142481759_4,ord_1765142481759_5,delay_ord_1765142490878_1,delay_ord_1765142490878_2,delay_ord_1765142490878_3,mixed_1765142495256_1,mixed_1765142495256_2,mixed_1765142495256_3,mixed_1765142495256_4,ooo_1765142501648_1,ooo_1765142501648_2,ooo_1765142501648_3,need_two_1765142509301,available_1765142514751,timing_w1_1765142516943,timing_w2_1765142516953,concurrent_1765142516960_4,concurrent_1765142516960_0,concurrent_1765142516960_3,concurrent_1765142516960_1,concurrent_1765142516960_6,concurrent_1765142516960_2,concurrent_1765142516960_5,concurrent_1765142516960_7,concurrent_1765142516960_8,concurrent_1765142516960_9,w1_test,w2_test,eventual_test_1765142521458,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5,order_764744_0,order_764744_1,order_764744_2,order_781739_0,order_781739_1,order_781739_2,dedup_multi_864734,dedup_multi_881717,test_dedup_964725,test_dedup_981698
Secondary (port 8002) order: timing_w1_1765142516943,timing_w2_1765142516953,concurrent_1765142516960_4,concurrent_1765142516960_0,concurrent_1765142516960_3,concurrent_1765142516960_1,concurrent_1765142516960_6,concurrent_1765142516960_2,concurrent_1765142516960_5,concurrent_1765142516960_7,concurrent_1765142516960_8,concurrent_1765142516960_9,w1_test,w2_test,eventual_test_1765142521458,default_w,w1_test,w2_test,e1,e2,e3,mix1,mix2,mix3,dup_test,ord1,ord2,ord3,ord4,ord5
❌ Ordering mismatch detected

==========================================
D. Error Handling
==========================================

D1. ERR-01: Invalid write concern rejected
----------------------------------------
Testing w=0 (invalid)...
✅ w=0 correctly rejected with HTTP 400
Testing w too large...
✅ w=4 correctly rejected with HTTP 400

D2. ERR-02: Secondary failure when w cannot be satisfied
----------------------------------------
⚠️  Manual test: Stop a secondary and try w=3
   docker compose stop secondary2
   Then POST with w=3 should fail with 502

D3. ERR-03: w=1 still succeeds with secondary failure
----------------------------------------
⚠️  Manual test: With secondary stopped, w=1 should succeed

==========================================
E. Additional Timing & Verification Tests
==========================================

E1. Verify w=1 timing (should be <10ms)
----------------------------------------
Testing w=1 response time...
Response duration_ms: 2ms
Real elapsed time: 0.014s
✅ w=1 is fast: 2ms

E2. Verify w=2 timing (should respond after 1st ACK)
----------------------------------------
Testing w=2 response time (should respond after 1st ACK, ~0-10ms if fast secondary responds first)...
Response: duration_ms=3ms, ACKs=1
Real elapsed time: 0.015s
Checking logs for timing details...
rl-master  | 2025-12-07 21:29:14,764 | INFO | Write concern w=3 satisfied with 2 ACKs, responding (remaining replications continue)
rl-master  | 2025-12-07 21:29:19,877 | INFO | Appended locally seq=173 msg=w2_timing_verify
rl-master  | 2025-12-07 21:29:19,881 | INFO | Write concern w=2 satisfied with 1 ACKs, responding (remaining replications continue)
✅ Got 1 ACK(s) (w=2 needs 1)

==========================================
Test Summary
==========================================
✅ Write concern semantics tested
✅ Eventual consistency verified
✅ Deduplication checked
✅ Total ordering verified
✅ Error handling tested

For full concurrency tests, run: python3 test_iteration2_concurrent.py

